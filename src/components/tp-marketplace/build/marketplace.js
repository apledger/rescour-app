/** Copyright (c) 2013 All Right Reserved, Nebuleaf Studios LLC, http://nebuleaf.com/. v1.0.0 **/
var thotpod=function(){function isArray(value){return"[object Array]"==toString.apply(value)}function isDate(value){return"[object Date]"==toString.apply(value)}function isObject(value){return null!=value&&"object"==typeof value}function copy(source,destination){if(destination){if(source===destination)throw Error("Can't copy equivalent objects or arrays");if(isArray(source)){for(;destination.length;)destination.pop();for(var i=0;i<source.length;i++)destination.push(copy(source[i]))}else{_.forEach(destination,function(value,key){delete destination[key]});for(var key in source)destination[key]=copy(source[key])}}else destination=source,source&&(isArray(source)?destination=copy(source,[]):isDate(source)?destination=new Date(source.getTime()):isObject(source)&&(destination=copy(source,{})));return destination}function setBit(idPos,bitSet){var bitSetIndex=parseInt(idPos/32,10);for(bitSet=bitSet||[];bitSet.length<=bitSetIndex;)bitSet.push(0);return bitSet[bitSetIndex]=bitSet[bitSetIndex]|1<<idPos%32,bitSet}function popcount(x){var m1=1431655765,m2=858993459,m4=252645135;return x-=x>>1&m1,x=(x&m2)+(x>>2&m2),x=x+(x>>4)&m4,x+=x>>8,x+=x>>16,127&x}function Dimensions(dimensions){var defaults=_.extend({title:"",discreet:{},range:{},visibleIds:[],idMap:[]}),discreetDefaults={values:{},selected:0,visibleIds:[]},rangeDefaults={excludeNA:!1,high:null,low:null},self=this;copy(defaults,this);for(var attrID in dimensions.discreet)if(dimensions.discreet.hasOwnProperty(attrID)){var _attr=dimensions.discreet[attrID],_discreet=_.extend(_attr,discreetDefaults);self.discreet[attrID]={},copy(_discreet,self.discreet[attrID])}for(var attrID in dimensions.range)if(dimensions.range.hasOwnProperty(attrID)){var _attr=dimensions.range[attrID],_range=_.extend(_attr,rangeDefaults);self.range[attrID]={},copy(_range,self.range[attrID])}}function Market(Model,opts){var activeItem=null,prevActive=null;_.extend(this,{sortBy:{}},opts),this.Model=Model,this.dimensions={},this.items={},this.visibleIds=[],this.visibleItems=[],this.subsetIds=[],this.initialized=!1,this.populated=!1,this.getActive=function(){return activeItem},this.getItems=function(){return _.map(this.items,function(val){return val})},this.setActive=function(id){return _.isObject(id)?(prevActive=activeItem,activeItem=id,activeItem.isActive=!0):this.items[id]?(prevActive=activeItem,activeItem=this.items[id],activeItem.isActive=!0):activeItem=null,prevActive&&(prevActive.isActive=!1),activeItem},this.getDimensions=function(){return this.dimensions},this.load=function(search){return this.dimensions.load(search),this}}var toString=Object.prototype.toString;return Dimensions.prototype.pushDiscreetId=function(attrID,idPosition,value){var _discreet=this.discreet[attrID];_discreet&&(value=value||"Unknown",_discreet.values.hasOwnProperty(value)?_discreet.values[value].ids=setBit(idPosition,_discreet.values[value].ids):(_discreet.values[value]={ids:[0],title:value,isSelected:!1},_discreet.values[value].ids=setBit(idPosition,_discreet.values[value].ids)))},Dimensions.prototype.load=function(search){var self=this,_search=_.extend({title:"",discreet:{},range:{}},search);self.id=_search.id||void 0,self.title=_search.title||"";for(var rangeID in self.range)if(_search.range.hasOwnProperty(rangeID)){var withinLowBound=_search.range[rangeID].lowSelected>=self.range[rangeID].low,withinHighBound=_search.range[rangeID].highSelected<=self.range[rangeID].high;withinLowBound&&withinHighBound?(self.range[rangeID].lowSelected=_search.range[rangeID].lowSelected,self.range[rangeID].highSelected=_search.range[rangeID].highSelected):!withinLowBound&&withinHighBound?(self.range[rangeID].lowSelected=self.range[rangeID].low,self.range[rangeID].highSelected=_search.range[rangeID].highSelected):withinLowBound&&!withinHighBound?(self.range[rangeID].lowSelected=_search.range[rangeID].lowSelected,self.range[rangeID].highSelected=self.range[rangeID].high):(self.range[rangeID].lowSelected=self.range[rangeID].low,self.range[rangeID].highSelected=self.range[rangeID].high)}else self.range.hasOwnProperty(rangeID)&&(self.range[rangeID].lowSelected=self.range[rangeID].low,self.range[rangeID].highSelected=self.range[rangeID].high);for(var discreetID in self.discreet)if(_search.discreet.hasOwnProperty(discreetID))for(var attrID in _search.discreet[discreetID].values)self.discreet[discreetID].values.hasOwnProperty(attrID)&&(_search.discreet[discreetID].values[attrID].isSelected&&!self.discreet[discreetID].values[attrID].isSelected?(self.discreet[discreetID].values[attrID].isSelected=!0,self.discreet[discreetID].selected++):!_search.discreet[discreetID].values[attrID].isSelected&&self.discreet[discreetID].values[attrID].isSelected&&(self.discreet[discreetID].values[attrID].isSelected=!1,self.discreet[discreetID].selected--));else if(self.discreet.hasOwnProperty(discreetID))for(var attrID in self.discreet[discreetID].values)self.discreet[discreetID].values.hasOwnProperty(attrID)&&self.discreet[discreetID].values[attrID].isSelected&&(self.discreet[discreetID].values[attrID].isSelected=!1,self.discreet[discreetID].selected--)},Dimensions.prototype.toArray=function(){var dimensionsArr=_.extend({},this,{discreet:_.map(this.discreet,function(val){return val}),range:_.map(this.range,function(val){return val})});return dimensionsArr},Dimensions.prototype.getDiscreet=function(){return _.map(this.discreet,function(val){return val})},Dimensions.prototype.getRange=function(){return _.map(this.range,function(val){return val})},Dimensions.prototype.reset=function(){return this.title="",this.id=void 0,this.discreet={},this.range={},this},Market.prototype.addModels=function(models){for(var _model in models)if(models.hasOwnProperty(_model)){var model=models[_model];try{this.mapModel(model)}catch(e){console.log(e.message)}}},Market.prototype.mapModel=function(model){var self=this,_item=self.items[model.id]=self.Model?new self.Model(model):model,idPosition=self.dimensions.idMap.length,dimensions=self.dimensions;dimensions.idMap.push(model.id);for(var _discreetKey in dimensions.discreet)if(dimensions.discreet.hasOwnProperty(_discreetKey)){var _discreetAttr=dimensions.discreet[_discreetKey];if("undefined"==typeof _item[_discreetKey])throw new Error("Cannot find discreet attribute: "+_discreetKey);if(_discreetAttr.multi)if(_item[_discreetKey].length)for(var i=0;i<_item[_discreetKey].length;i++){var _discreetVal,_itemAttr=_item[_discreetKey][i]=_item[_discreetKey][i]||"Unknown";_discreetVal=_discreetAttr.restrict?_.contains(_discreetAttr.restrict,_itemAttr)?_itemAttr:"Other":_itemAttr,self.dimensions.pushDiscreetId(_discreetKey,idPosition,_discreetVal)}else self.dimensions.pushDiscreetId(_discreetKey,idPosition,"None");else{var _discreetVal;_item[_discreetKey]=_item[_discreetKey]||"Unknown",_discreetVal=_discreetAttr.restrict?_.contains(_discreetAttr.restrict,_item[_discreetKey])?_item[_discreetKey]:"Other":_item[_discreetKey],self.dimensions.pushDiscreetId(_discreetKey,idPosition,_discreetVal)}}for(var _rangeKey in dimensions.range)if(dimensions.range.hasOwnProperty(_rangeKey)){var _itemAttr,_rangeAttr=self.dimensions.range[_rangeKey];if("undefined"==typeof _item[_rangeKey])throw new Error("Cannot find range attribute: "+_rangeKey);_itemAttr=_item[_rangeKey]=isNaN(parseFloat(_item[_rangeKey]))?"NA":parseFloat(_item[_rangeKey]),_rangeAttr.highBound?_rangeAttr.high=_rangeAttr.highSelected=_rangeAttr.highBound:(_itemAttr>=_rangeAttr.high||null==_rangeAttr.high)&&"NA"!==_itemAttr&&(_rangeAttr.high=_rangeAttr.highSelected=_itemAttr),_rangeAttr.lowBound?_rangeAttr.low=_rangeAttr.lowSelected=_rangeAttr.lowBound:(_itemAttr<=_rangeAttr.low||null==_rangeAttr.low)&&"NA"!==_itemAttr&&(_rangeAttr.low=_rangeAttr.lowSelected=_itemAttr)}},Market.prototype.initialize=function(dimensions,models){if(!dimensions&&!this.dimensions)throw new Error("Dimensions must be defined in order to initialize Marketplace");return this.items={},this.dimensions=dimensions?new Dimensions(dimensions):this.dimensions,models&&(this.addModels(models),this.populated=!0,this.apply(),this.predict()),this.initialized=!0,this.items},Market.prototype.apply=function(){var dimensions=this.dimensions,items=this.items;this.subsetIds=[],this.visibleIds=[],this.visibleItems=[],dimensions.visibleIds=[];var i,BIT_SET_LENGTH=Math.ceil(dimensions.idMap.length/32),bitSet=[];for(i=0;BIT_SET_LENGTH>i;i++){bitSet.push(-1);for(var attrId in dimensions.discreet)if(dimensions.discreet.hasOwnProperty(attrId)){var _discreet=dimensions.discreet[attrId],union=_discreet.multi?-1:0;for(var valueId in _discreet.values)if(_discreet.values.hasOwnProperty(valueId)){var _value=_discreet.values[valueId];if(_discreet.multi){if(0===_discreet.selected)break;_value.isSelected&&(union&=_value.ids[i])}else(_value.isSelected||0===_discreet.selected)&&(union|=_value.ids[i])}_discreet.visibleIds[i]=union,bitSet[i]=bitSet[i]&union}for(var p=0;32>p;p++){var itemIndex=32*i+p;if(dimensions.idMap[itemIndex]){var _currItem=items[dimensions.idMap[itemIndex]];if(_.isEmpty(dimensions.range))_currItem.isVisible=!!(1&bitSet[i]),_currItem.isVisible&&(dimensions.visibleIds=setBit(itemIndex,dimensions.visibleIds),this.visibleIds.push(dimensions.idMap[itemIndex]),this.visibleItems.push(_currItem));else{for(var _rangeKey in dimensions.range)if(dimensions.range.hasOwnProperty(_rangeKey)){var _rangeAttr=dimensions.range[_rangeKey],_currItemAttr=_currItem[_rangeKey],_isWithinLow=_currItemAttr>=_rangeAttr.lowSelected||_rangeAttr.lowSelected==_rangeAttr.lowBound,_isWithinHigh=_currItemAttr<=_rangeAttr.highSelected||_rangeAttr.highSelected==_rangeAttr.highBound;if(!(_isWithinLow&&_isWithinHigh||"NA"===_currItemAttr&&!_rangeAttr.excludeNA)){_currItem.isVisible=!1;for(var _discreetKey in dimensions.discreet)if(dimensions.discreet.hasOwnProperty(_discreetKey)){var _discreetAttr=dimensions.discreet[_discreetKey],_mask=~(1<<p);_discreetAttr.visibleIds[i]=_discreetAttr.visibleIds[i]&_mask}break}_currItem.isVisible=!!(1&bitSet[i])}this.subset&&"all"!==this.subset?(_currItem.isVisible=_currItem.isVisible&&_currItem[this.subset],_currItem[this.subset]&&(this.subsetIds=setBit(itemIndex,this.subsetIds))):(_currItem.isVisible=_currItem.isVisible&&!_currItem.hidden,_currItem.hidden||(this.subsetIds=setBit(itemIndex,this.subsetIds))),_currItem.isVisible&&(dimensions.visibleIds=setBit(itemIndex,dimensions.visibleIds),this.visibleIds.push(dimensions.idMap[itemIndex]),this.visibleItems.push(_currItem))}}bitSet[i]=bitSet[i]>>1}}return this.sortVisibleItems()},Market.prototype.predict=function(){var dimensions=this.dimensions,BIT_SET_LENGTH=Math.ceil(dimensions.idMap.length/32);for(var attrId in dimensions.discreet)if(dimensions.discreet.hasOwnProperty(attrId)){var _discreet=dimensions.discreet[attrId];for(var valueId in _discreet.values)if(_discreet.values.hasOwnProperty(valueId)){var _value=_discreet.values[valueId];if(!_value.isSelected&&_discreet.selected>0){for(var predictLength=0,predictBitSet=[],i=0;BIT_SET_LENGTH>i;i++){var predictedUnion=_discreet.visibleIds[i]|_value.ids[i];predictBitSet.push(-1);for(var predictAttrId in dimensions.discreet)if(dimensions.discreet.hasOwnProperty(predictAttrId)){var _predictDiscreet=dimensions.discreet[predictAttrId];predictBitSet[i]=predictAttrId===attrId?predictBitSet[i]&predictedUnion:predictBitSet[i]&_predictDiscreet.visibleIds[i]}predictLength+=popcount(predictBitSet[i]&_value.ids[i]&this.subsetIds[i])}predictLength?(_value.badge="badge-success",_value.predict="+"+predictLength):(_value.badge=null,_value.predict=0)}else{_value.predict=0;for(var i=0;BIT_SET_LENGTH>i;i++)_value.predict+=popcount(dimensions.visibleIds[i]&_value.ids[i]);_value.badge=_value.predict?"badge-info":""}}}},Market.prototype.sortVisibleItems=function(predicate,reverse){function compare(a,b){var v1=a[_predicate]||a[_predicate]||null,v2=b[_predicate]||b[_predicate]||null,t1=typeof v1,t2=typeof v2;return t1==t2?("string"==t1&&(v1=v1.toLowerCase()),"string"==t1&&(v2=v2.toLowerCase()),v1===v2?0:v2>v1?-1:1):v2>v1?-1:1}var _predicate=predicate||this.sortBy.predicate,_reverse="undefined"==typeof reverse?this.sortBy.reverse:reverse,_items=[],_naItems=[];if(!_predicate)return this.visibleItems;for(var i=this.visibleItems.length-1;i>=0;i--){var _item=this.visibleItems[i],_attr=_item[_predicate]||_item[_predicate]||null;"NA"==_attr?_naItems.push(_item):_items.push(_item)}return _items.sort(_reverse?compare:function(a,b){return compare(b,a)}),this.visibleItems=_items.concat(_naItems),this.sortBy={predicate:_predicate,reverse:_reverse},this.visibleItems},Market.prototype.toggleDiscreet=function(discreet,value){return discreet&&value&&(value.isSelected=!value.isSelected,value.isSelected?discreet.selected++:discreet.selected--),this},Market.prototype.applyRange=function(rangeKey,low,high){if(!this.dimensions.range.hasOwnProperty(rangeKey))throw new Error("Cannot find range dimension "+rangeKey);var _range=this.dimensions.range[rangeKey];return _range.lowSelected=low,_range.highSelected=high,this},Market.prototype.excludeNA=function(rangeKey){return this.dimensions.range[rangeKey].excludeNA=!0,this},Market.prototype.includeNA=function(rangeKey){return this.dimensions.range[rangeKey].excludeNA=!1,this},{Marketplace:Market}}();